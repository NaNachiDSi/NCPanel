import os
import logging
import asyncio
from gtts import gTTS
from twitchio.ext import commands
import pygame
import time

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(message)s')

OAUTH_TOKEN = os.getenv("OAUTH_TOKEN")
BOTNICK = os.getenv("BOTNICK")
CHANNEL = os.getenv("CHANNEL")
INTERVAL = 3

EMOTES = [   
    "!unfollow",
    "1984",
    "2head",
    "3dart",
    "3head",
    "3heading",
    "3headrave",
    "4weird",
    "4weirdbusiness",
    "5head",
    "60seconds",
    "7tv",
    "8kultrahd",
    ":0",
    ":3",
    ":9",
    ":tf:",
    "????",
    "a",
    "adge",
    "adhd",
    "agreeing",
    "aintfuckingnoway",
    "aintnoway",
    "aintnowayintoouterspace",
    "alert",
    "alienfloss",
    "alienparty",
    "alienpls",
    "alienpls2",
    "alienpls3",
    "alienpls6",
    "alienrave",
    "alienunpleased",
    "aloo",
    "aloo",
    "android",
    "angry",
    "applecatrun",
    "apuguitar",
    "apujam",
    "apured",
    "apusquats",
    "areyouagirl",
    "arnoldhalt",
    "ascend",
    "ass",
    "assemble",
    "aufbankrott",
    "aufblock",
    "aufchillovanillo",
    "aufdeutschenhungerzock",
    "aufgebruderstreich",
    "aufhivebann",
    "aufhot",
    "aufkulturschock",
    "auflattenseppmitstock",
    "auflocka",
    "aufmod",
    "aufschillock",
    "aufschmeckedischmackedischmock",
    "austriainternet",
    "austriakisser",
    "aware",
    "awkward",
    "ayo",
    "ayooo",
    "backseating",
    "baldge",
    "banger",
    "banger",
    "banned",
    "based",
    "bastiansdeutschehungerspiele",
    "bedge",
    "beertime",
    "believers",
    "believers",
    "bingchilling",
    "bitrate",
    "bitti",
    "blablabla",
    "blelele",
    "blessrng",
    "bloonsge",
    "boating",
    "booba",
    "boobapeek",
    "bought",
    "breh",
    "browtf",
    "buhbbles",
    "buhh",
    "buhharrive",
    "buhhaw",
    "buhhbye",
    "buhhcry",
    "buhhddies",
    "buhhlolipop",
    "buhhmeeting",
    "buhhsiness",
    "buhich",
    "burgenland",
    "bye",
    "catblobdance",
    "catjam",
    "catsittingverycomfortablearoundacampfirewithitsfriends",
    "cattwerk",
    "catum",
    "catwait",
    "catwink",
    "caught",
    "caughtin4k",
    "cc",
    "chadge",
    "chaosflo",
    "chaosflopls",
    "chatting",
    "cinema",
    "clapping",
    "classic",
    "clean",
    "clown",
    "clueless",
    "coffeetime",
    "coggers",
    "cokebert",
    "cooked",
    "copeless",
    "copium",
    "cowjam",
    "coze",
    "crunch",
    "d:",
    "damn",
    "dance",
    "dancingbananabtd",
    "dankies",
    "danseparty",
    "dark",
    "dawg",
    "death",
    "despairge",
    "detonatebedge",
    "deutschge",
    "devious",
    "diesofbedge",
    "diesofcringe",
    "dinkdonk",
    "dinkdonk",
    "dinocry",
    "discord",
    "dogedance",
    "doglookingsussyandcold",
    "donkdrip",
    "donowall",
    "donowall",
    "doyoufeeltheweightofyoursinsdoesithurtdoesgodsjudgementfillyouwithguilttormenttheyrecomingtheyrecomi",
    "dustinkst",
    "dvd",
    "eboy",
    "ed",
    "edm",
    "elmofire",
    "elprimo",
    "entireshrekmovie",
    "essaying",
    "evilowo",
    "ez",
    "ezclap",
    "fabo",
    "faister",
    "faisterhappy",
    "fance",
    "fatasswizardblicky",
    "fatasswizardblicky2",
    "fatasswizardbozo",
    "fatasswizardcastsafireballonyou",
    "fatasswizardcastsbanishment",
    "fatasswizardcastsbarrier",
    "fatasswizardcastsice",
    "fatasswizardcastslightning",
    "fatasswizardcaststeleportation",
    "fatasswizardcatdrunk",
    "fatasswizardgamba",
    "fatasswizardgoestobed",
    "fatasswizardrose",
    "feelsbitrateman",
    "feelsdankman",
    "feelsdonkman",
    "feelsgladman",
    "feelslagman",
    "feelslateman",
    "feelslockman",
    "feelsoldman",
    "feelsqueueman",
    "feelsrainman",
    "feelswaytoogood",
    "feelsweakman",
    "feelsweirdman",
    "filowtasty",
    "firsttimebackseating",
    "firsttimebot",
    "firsttimechadder",
    "firsttimechatter",
    "firsttimeraider",
    "fishh",
    "flammkuchen",
    "flashbang",
    "flashbang",
    "flush",
    "flushe",
    "flushed",
    "flushedcat",
    "flutetime",
    "forsenautismo",
    "forsencd",
    "forsenparty",
    "fr",
    "fraud",
    "freddypls",
    "freebear",
    "freedom",
    "frenn",
    "frens",
    "frfr",
    "fridge",
    "frogdance",
    "gachi",
    "gachibop",
    "gachihop",
    "gachihopper",
    "gachihyper",
    "gachipride",
    "gamba",
    "gamba2",
    "gambaaddict",
    "gameplaytime",
    "gaming",
    "gayge",
    "gefgef",
    "getoutofmyhead",
    "getouttahere",
    "gg",
    "ghg",
    "gigamods",
    "gigachad",
    "gladge",
    "gladgers",
    "glueless",
    "gomme",
    "gommemode",
    "goodmorning",
    "goodstream",
    "goodtake",
    "goofyahh",
    "gooning",
    "gotcaughttrolling",
    "groupmeeting",
    "guitartime",
    "gunn",
    "guntimer",
    "guysrefreshchatterinoiuploadedanotheremote",
    "hackermans",
    "hahaha",
    "halbebibel",
    "halbebibel",
    "hamster",
    "handsup",
    "happe",
    "happie",
    "happytree",
    "hatechatting",
    "hehe",
    "hewillnever",
    "heyy",
    "hi",
    "hmm",
    "hmmmok",
    "hopium",
    "hugo",
    "huh",
    "hundvonpapaplatte",
    "hurensohn",
    "hyperclap",
    "hypers",
    "icant",
    "icanttakeitanymore",
    "icanttakeitanymore",
    "internetge",
    "jailtime",
    "jamgie",
    "joever",
    "jokergedetected",
    "juicetime",
    "justchattingtime",
    "kapp",
    "kirbyjam",
    "kitten",
    "kittysus",
    "kkalinka",
    "kkomrade",
    "kkonaw",
    "kkool",
    "kok",
    "l",
    "lasttimechatter",
    "latege",
    "lebronjam",
    "leftthand",
    "lethimcook",
    "letsgo",
    "letsgooo",
    "life",
    "lifeisroblox",
    "lipbite",
    "listening",
    "livereaction",
    "lmaooo",
    "loading",
    "lockk",
    "lol",
    "lole",
    "lolw",
    "lookup",
    "love",
    "lovemods",
    "lulw",
    "lurkk",
    "mad",
    "madge",
    "madgeclap",
    "madgelate",
    "madgi",
    "maj",
    "maloche",
    "malphbed",
    "mathtime",
    "meowdy",
    "mexicanos",
    "mexify",
    "mhm",
    "mindtrickge",
    "mitosis",
    "mlady",
    "modcheck",
    "modcheck",
    "modd",
    "modding",
    "modge",
    "monkaban",
    "monkadmca",
    "monkaeyes",
    "monkahmm",
    "monkamath",
    "monkas",
    "monkasteer",
    "monkatos",
    "monkaw",
    "monkax",
    "monke",
    "monkekiss",
    "monkeswim",
    "monkeyinawatermelontrainwtfthisiscrazy",
    "montanablack88",
    "moodge",
    "muga",
    "muted",
    "muted",
    "myexistenceisnothingbutagrainofsandcomparedtotheentirescaleoftheuniverse",
    "myeyes",
    "myhonestreaction",
    "myiq",
    "ncs",
    "nebelniek",
    "nerd",
    "nerdge",
    "nice",
    "nicehost",
    "nodders",
    "noidontthinkso",
    "noonecares",
    "nooo",
    "noooo",
    "nooreax",
    "nopers",
    "notallowed",
    "nothanks",
    "notlistening",
    "notlookingatbooba",
    "nowaying",
    "npc",
    "nt",
    "nyanpls",
    "o7",
    "ofcourse",
    "offline",
    "offlinechat",
    "oh",
    "ohcute",
    "ohhkebab",
    "ohmies",
    "ohno",
    "ohstop",
    "ok",
    "okaygi",
    "okayipullup",
    "okok",
    "oldge",
    "ome",
    "ome",
    "omegadance",
    "omegadancebutfast",
    "omegalul",
    "omegaluliguess",
    "omg",
    "onemore",
    "ono",
    "oooo",
    "outtapocket",
    "pagbounce",
    "pagchomp",
    "pagshake",
    "paidchatter",
    "pain",
    "paluten",
    "papa",
    "papaplatte",
    "parasocialfrenn",
    "partykirby",
    "pause",
    "pausechamp",
    "pauseman",
    "payout",
    "pdffile",
    "peak",
    "pedro",
    "peepoads",
    "peepoarrive",
    "peepobelievers",
    "peepoburnmoney",
    "peepobye",
    "peepochat",
    "peepocheer",
    "peepoclap",
    "peepoclown",
    "peepocozy",
    "peepodj",
    "peepodoubters",
    "peepofeet",
    "peepofinger",
    "peepofree",
    "peepogaze",
    "peepogiggles",
    "peepohey",
    "peepohiddengiggles",
    "peepojammer",
    "peepomine",
    "peeponerd",
    "peepopat",
    "peepopopcorn",
    "peeporiot",
    "peeporun",
    "peeporuncry",
    "peeposadswipe",
    "peeposhower",
    "peeposhrug",
    "peeposhy",
    "peeposithey",
    "peeposmash",
    "peepotalk",
    "peepotalkaustria",
    "peepotoxic",
    "peepovanish",
    "peepowow",
    "peepowtf",
    "pepebass",
    "pepeclown",
    "pepecringe",
    "peped",
    "pepefastjam",
    "pepega",
    "pepegablind",
    "pepegadriving",
    "pepegagun",
    "pepejam",
    "pepejamjam",
    "pepel",
    "pepelaugh",
    "pepemeltdown",
    "pepenoted",
    "pepenpc",
    "pepepoint",
    "pepes",
    "pepesadjam",
    "pepespit",
    "pepodance",
    "pepog",
    "pepojs",
    "pepopopcorn",
    "personwithautism",
    "petthebelievers",
    "petthechat",
    "petthedoubters",
    "petthemods",
    "petthepeepo",
    "pettheraiders",
    "petthestreamer",
    "petthevips",
    "pianotime",
    "piston",
    "pizzatime",
    "please",
    "pog",
    "poggers",
    "poggies",
    "pogo",
    "pogtasty",
    "pogu",
    "pointless",
    "police",
    "police2",
    "popcorntime",
    "poroblunt",
    "pou",
    "ppjedi",
    "ppparty",
    "prayge",
    "praygi",
    "praying",
    "predicting",
    "programming",
    "psp60secondtimeout",
    "qp",
    "que",
    "quicknotes",
    "rage",
    "ragey",
    "rapthis",
    "ratio",
    "ratjam",
    "rave",
    "ravecat",
    "ravedance",
    "realization",
    "reallymad",
    "reeze",
    "resetting",
    "rewi",
    "rewi",
    "righthand",
    "ripbozo",
    "roach",
    "robert",
    "rumathra",
    "rustaceans",
    "sadge",
    "sadgecry",
    "sadgerain",
    "sadgi",
    "sadjam",
    "sadkek",
    "sadmoment",
    "sadtree",
    "saguipls",
    "saj",
    "salutt",
    "saxtime",
    "scamba",
    "scatter",
    "scheming",
    "schizo",
    "schonmalnedickegepopptschere",
    "sexo",
    "sgiggle",
    "shiza",
    "shoo",
    "shrujj",
    "sigma",
    "sillytree",
    "singg",
    "sippin",
    "sisyphus",
    "skaipcall",
    "skip",
    "skype",
    "skypedrunk",
    "skypeemo",
    "skypefinger",
    "skypegiggle",
    "skypenerd",
    "skypenod",
    "skypepuke",
    "skypepunch",
    "skyperock",
    "skypesad",
    "skypesmirk",
    "skypewonder",
    "skypeworried",
    "slapp",
    "smadge",
    "smadging",
    "sniffa",
    "soapcarving",
    "socialcreditsdown",
    "socialcreditsup",
    "speedr",
    "spinning",
    "spinnu0",
    "stab",
    "stare",
    "staree",
    "starman",
    "stegi",
    "stonk",
    "stonks",
    "stopbeingmean",
    "storytime",
    "streamer",
    "streamerdoesntknow",
    "streamoffline",
    "stronge",
    "strongi",
    "suetolog",
    "sure",
    "sus",
    "susgi",
    "suske",
    "sussy",
    "sussy",
    "teatime",
    "thevoices",
    "thinkge",
    "thinking",
    "thinking2",
    "thischat",
    "timeout",
    "tomatolix",
    "tomfoolery",
    "toosmart",
    "touchsomegrass",
    "triangd",
    "tridance",
    "trifi",
    "trikool",
    "trimec",
    "trisad",
    "trolldespair",
    "trombonetime",
    "trymacs",
    "tssk",
    "tuckk",
    "uhm",
    "ultramad",
    "um",
    "ummm",
    "unlucky",
    "unlucky",
    "unpaidchatter",
    "uuh",
    "uwu",
    "uwu",
    "uwu",
    "verysadge",
    "vibe",
    "vibee",
    "vibeeparty",
    "vibepls",
    "violintime",
    "vitawirt",
    "voices",
    "volumeup",
    "vs",
    "w",
    "waaaaave",
    "waga",
    "wait",
    "waiting",
    "waitingangry",
    "wandl",
    "wandr",
    "war",
    "watertime",
    "waytoodank",
    "waytooloud",
    "waytoosmart",
    "weirdchamp",
    "weirddude",
    "weirdge",
    "wewaiting",
    "what",
    "whattaahfuck",
    "where",
    "whoasked",
    "whomegalul",
    "wicked",
    "wickedsteer",
    "widealert",
    "widebuhh",
    "widehardo",
    "widepeepohappy",
    "widerave",
    "wielandwelte",
    "wikked",
    "wisemysticaltree",
    "wokege",
    "wooperjam",
    "ww",
    "xar2edm",
    "xd",
    "xdd",
    "xqcmilktime",
    "xylilmaomyassoff",
    "yep",
    "yesidothinkso",
    "yesyes",
    "yoink",
    "yougotme",
    "yourmom",
    "yuumijam",
    "zarbex",
    "zazabert",
    "zidanepog",
    "zyzzbass",
    "zyzzpls",
    "zyzzrave",
]

def filter_message(message):
    for word in EMOTES:
        message = message.replace(word, "")
    return message

class Bot(commands.Bot):
    def __init__(self):
        super().__init__(token=OAUTH_TOKEN, prefix="!", initial_channels=[CHANNEL])
        self.chat_message = None

    async def event_message(self, message):
        if len(message.content) <= 187  and len(message.content) > 0 and message.author.name.lower() not in ["Fossabot", "streamelements", "nightbot", "moobot"] and not "https://" in message.content: # and message.content.startswith("#"):
            self.chat_message = message.content
            self.author = message.author.name

async def read_chat():
    bot = Bot()
    asyncio.create_task(bot.start())
    lastmessage = None
    
    pygame.mixer.init()

    while True:
        await asyncio.sleep(INTERVAL)
        try:
            if bot.chat_message != lastmessage:
                filtered = filter_message(bot.chat_message)
                filename = "voice.mp3"

                if os.path.exists(filename):
                    try:
                        os.remove(filename)
                    except PermissionError:
                        logging.warning(f"Cannot remove {filename} - file may still be in use")
                        continue

                voice = gTTS(text=filtered, lang="de")
                voice.save(filename)
                
                pygame.mixer.music.load(filename)
                pygame.mixer.music.play()

                while pygame.mixer.music.get_busy():
                    await asyncio.sleep(0.1)

                pygame.mixer.music.stop()

                pygame.mixer.quit()
                time.sleep(0.1)

                try:
                    os.remove(filename)
                    logging.info(f"{bot.author}: {filtered}")
                except Exception as e:
                    logging.error(f"Fehler beim LÃ¶schen der Datei {filename}: {e}")

                pygame.mixer.init()

                lastmessage = bot.chat_message

        except Exception as e:
            logging.error(f"Fehler: {e}")

if __name__ == "__main__":
    try:
        asyncio.run(read_chat())
    except KeyboardInterrupt:
        logging.info("Beendet")
    except Exception as e:
        logging.error(f"Fehler: {e}")